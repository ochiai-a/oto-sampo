version: 0.2

phases:
  build:
    commands:
      # 現在のバージョンを取得
      - echo "Getting current version..."
      - CurrentVersion=$(aws lambda get-alias --function-name ExternalApiCallerLambda --name dev --query 'FunctionVersion' --output text)
      - echo CurrentVersion=$CurrentVersion

      # 新しいバージョンを発行
      - echo "Publishing new version..."
      - aws lambda publish-version --function-name ExternalApiCallerLambda
      - TargetVersion=$(aws lambda list-versions-by-function --function-name ExternalApiCallerLambda --query 'Versions[-1].Version' --output text)
      - echo TargetVersion=$TargetVersion

      # プレースホルダーを置き換え
      - echo "Updating appspec.yml..."
      - sed -i -e "s/{{CurrentVersion}}/$CurrentVersion/g" appspec.yml
      - sed -i -e "s/{{TargetVersion}}/$TargetVersion/g" appspec.yml

artifacts:
  files:
    - "appspec.yml"
    - "**/*"